# Minimal Build pipeline
# This allow us to generate wheels and upload that to a feed.

variables:
  artifactFeed:

  WHEELS_DIR: /tmp/tensorflow_pkg
  bazel.startup.opts: --batch_cpu_scheduling --io_nice_level 7
  bazel.build.opts: --jobs 6 --local_ram_resources=HOST_RAM*0.8

name: $(BuildDefinitionName)_$(SourceBranchName)_$(BuildID)
stages:
  - stage: Build
    jobs:
      - job: bazelBuild
        timeoutInMinutes: 1440
        cancelTimeoutInMinutes: 5
        strategy:
          matrix:
            linux_python38:
              imageName: 'ubuntu-20.04'
              python.version: '3.8'
              use.bazel.version: 3.1.0
            macos1015_python38:
              imageName: 'macOS-10.15'
              python.version: '3.8'
              use.bazel.version: 3.1.0
        displayName: Bazel build
        pool:
          vmImage: $(imageName)
        steps:
          - template: templates/python-dev.yml
          - template: templates/check-bazel.yml
          - bash: |
              pushd $BUILD_SOURCESDIRECTORY
              yes "" | ./configure
              popd
            displayName: "Configure a default TF2 build"
          - template : templates/wheel-version.yml
          - bash: |
              bazel $BAZEL_STARTUP_OPTS build $BAZEL_BUILD_OPTS //tensorflow/tools/pip_package:build_pip_package
            displayName: 'Bazel build'
          - bash: |
              tensorflow/tools/pip_package/build_pip_package.sh $(WHEELS_DIR)
            displayName: 'Generate Wheels'
          - task: TwineAuthenticate@1
            displayName: 'Twine Authenticate'
            inputs:
              artifactFeed: ${{variables.artifactFeed}}
          - bash: |
              python -m twine upload -r ${{variables.artifactFeed}} $(WHEELS_DIR)/*
            displayName: 'Upload to ray-feed'
          - task: ComponentGovernanceComponentDetection@0
            inputs:
              scanType: 'Register'
              verbosity: 'Verbose'
              dockerImagesToScan: ''
              alertWarningLevel: 'Critical'
              failOnAlert: false
              ignoreDirectories: ''
trigger:
  branches:
    include:
      - master
      - releases/*
      - development
pr:
  branches:
    include:
      - master
      - releases/*
      - development